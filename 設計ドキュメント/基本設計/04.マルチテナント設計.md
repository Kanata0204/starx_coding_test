# マルチテナント・セキュリティの概略設計

## 1. はじめに
本設計文書は、マルチテナント環境におけるセキュリティの基本方針と実装戦略を示すものです。複数の顧客（テナント）が同一のシステム基盤を共有する場合に必要なデータ分離、アクセス制御、および安全な通信の実現方法を概説します。

## 2. マルチテナント環境の特徴とセキュリティ要件
- **データ分離**：各テナントのデータが他のテナントから隔離され、漏洩や不正アクセスが発生しないようにする。
- **アクセス制御**：テナント内の異なるユーザーや役割に応じて、適切な権限管理を行う。
- **認証・認可**：ユーザー認証を強化し、各リクエストにおける認可を確実にする。
- **通信のセキュリティ**：全通信をHTTPSで暗号化し、安全なデータの送受信を保証する。

## 3. データ分離の戦略
- **論理的分離**：データベース内でテナントIDを用いてデータを分離。各テーブルに `tenant_id` を持たせ、クエリ時にテナントフィルタを適用する。
- **物理的分離（将来的な選択肢）**：必要に応じて、テナントごとのデータベース分割やスキーマ分割を検討。

## 4. テナント識別方法
- **サブドメインベース**：各テナントに固有のサブドメインを割り当て、リクエスト時にサブドメインからテナントを特定。
- **リクエストヘッダー・トークン**：JWT内にテナント情報を含めるなど、認証トークンからテナントを判別。

## 5. 認証・認可の設計
- **認証**：  
  - RailsのDeviseなどを用いて、ユーザー認証機能を実装。
  - シングルサインオン（SSO）を将来的に導入する場合、OAuth/OpenID Connectなどのプロトコルを活用。
  
- **認可**：  
  - Punditなどの認可ライブラリを用いて、ユーザーの権限に応じたアクセス制御を実施。
  - 各リクエストにおいて、テナントIDおよびユーザーのロールに基づいたポリシーを適用。

## 6. 通信のセキュリティ
- **HTTPS通信**：全てのクライアント・サーバー間通信をHTTPSで暗号化。
- **JWTトークン**：認証情報およびテナント情報を含むJWTを使用し、安全なトークンベースの認証を実現。

## 7. アクセス制御と監査
- **アクセスログの記録**：誰がいつどのデータにアクセスしたかをログとして記録。これにより、不正アクセスの検知や監査が可能。
- **監査ログの保管と分析**：定期的にログを分析し、セキュリティインシデントに備える。

## 8. マルチテナント・セキュリティの実装方針
- **Railsでのテナント判別**：  
  - サブドメインまたはJWTに含まれるテナントIDを用いて、各リクエスト処理時に現在のテナントを決定。
  - モデルやコントローラで `current_tenant` を設定し、テナントフィルタを適用。
  
- **認証・認可の基本方針**：  
  - Deviseを用いた強固な認証基盤の構築。
  - Punditによるロールベースの認可制御を実装。各アクションでテナントとユーザーの権限を検証。

- **通信方式**：  
  - API通信は全てHTTPSで行い、JWTトークンによってユーザーおよびテナントを認証・認可。

## 9. 将来的な拡張と考慮事項
- **SSOの導入**：必要に応じて、外部IDプロバイダーとの連携を設計に組み込み、シングルサインオンを実現。
- **データ分離の強化**：顧客数やデータ量の増加に応じて、物理的なデータ分離や専用インスタンスへの移行を検討。
- **セキュリティ強化**：定期的なセキュリティ監査や脆弱性診断を実施し、設計を見直し。
